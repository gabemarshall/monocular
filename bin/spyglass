#!/usr/bin/env ruby
require 'faraday'
require 'json'
require 'slop'
require_relative('../lib/http')

opts = Slop.parse do |o|
  o.string '-h', '--host', 'Monocle API Host'
  o.string '-k', '--key', 'API Key'
  o.string '-q', '--query', 'API Search Query'
  o.string '-p', '--port', 'Enable debug mode'
  o.string '-o', '--output', 'Save Output to json'
  o.bool '--ssl', 'Force SSL/TLS'
  o.bool '--tls', 'Force SSL/TLS'
end

str = (STDIN.tty?) ? '' : $stdin.readlines
services = []

if str.class == Array
    str.each do |line|
        service = line.strip!.split(':')
        if service.length > 1
        	services.push(ip: service[0], port: service[1].strip)
        else
        	services.push(ip: service[0], port: opts[:port])
        end
    end
end

response_data = HttpGrabber.run(services, opts)
if opts[:output]
	File.open(opts[:output], 'w') do |file| 
		response_data.each do |response|
		    file.write response.to_json+"\n"
		end
	end
else
	puts response_data.to_json
end

